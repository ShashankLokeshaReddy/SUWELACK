{% extends "base.html" %}
{% block title %} {{ _('Gemeinkosten ändern') }} {% endblock %}


{% block content%}
<div>
<form method="post" action="{{ url_for('gemeinkostenandern',userid=userid)}}">

<div class="containerr statustable">
<h3>{{ _('Gemeinkosten ändern') }}</h3>
</div>

<div class="flex-container">
  <div class="flex-row">
    <div class="flex-nested-row">
      <label class="textclass" > {{ pers_no }} &emsp; {{ username }} </label>
    </div>
  </div>
</div>

<div class="flex-container">
  <div class="flex-row">
    <div class="flex-nested-row">
      <input type="text" class="textclass" name="anfangTS" id="anfangTS" value={{ anfangTS }} ></input>
    </div>
  </div>
  <div class="flex-row">
    <div class="flex-nested-row flex-right">
      <label for="datum" class="textclass">{{ _('Datum') }}: &emsp; </label>
      <input type="date" name="datum" id="datum" value={{ date }} class="form-control datetime"></input>
    </div>
  </div>
</div>

<div class="flex-container">
  <div class="flex-row">
    <div class="flex-nested-row">
      <label for="arbeitsplatz" class="textclass">{{ _('Buchungstag') }}Gruppe:  &emsp;</label>
      <select name="arbeitsplatz" id="arbeitsplatz" class="ARBT form-control">
		{% for item in auftraglst[0] %}
			<option value="{{item.1}}">{{item.1}}</option>
	  	{% endfor %}
	</select>
    </div>
  </div>
  <div class="flex-row">
    <div class="flex-nested-row flex-center">
		<label for="Gemeinkosten" class="textclass">{{ _('Gemeinkosten') }}:  &emsp;</label>
		<select name="gemeinkosten" id="Gemeinkosten" class="form-control">
		</select>
    </div>
  </div>
  <div class="flex-row">
    <div class="flex-nested-row flex-right">
    <label for="Dauer" class="textclass">{{ _('Dauer') }}: &emsp;</label>
	<select name="dauer" id="dauer" class="DAU form-control">
        {% for items in range(0,dauer|length) %}
        	<option value="{{dauer[items]}}">{{dauer[items]}}</option>
		{% endfor %}
	</select>
    </div>
  </div>
</div>

<div class="flex-container">
  <div class="flex-row">
    <div class="flex-nested-row">
      <label for="GKA" class="textclass">{{ _('Kurztext') }}: &emsp;</label>
      <input type="text" name="kurztext" id="GKA" class="form-control">
    </div>
  </div>
  <div class="flex-row">
    <div class="flex-nested-row flex-right">
      <button type="submit" name="submit" value="ändern" id="Ändern" class="btn btn-secondary  btn-lg submit2">{{ _('Ändern') }}</button>
    </div>
  </div>
  <div class="flex-row">
    <div class="flex-nested-row flex-right">
      <button type="submit" name="submit" value="erstellen" id="Erstellen" class="btn btn-secondary  btn-lg submit2">{{ _('Erstellen') }}</button>
    </div>
  </div>
</div>

<input type="text" name ='old_beleg_nr' id ='old_beleg_nr' style="visibility: hidden"> 
</input>

<div class="panel-body">
	
	<div class="tbl_user_data"></div>

</div>

</form>
</div>

<script>

$(function(){
	const arbeitsplatz = document.querySelector("#arbeitsplatz");
    arbeitsplatz.addEventListener("change", function() {
	var arbpltz_val = arbeitsplatz.value;
	var selectvalues =  JSON.parse('{{ auftraglst_ajax | tojson | safe}}');
	for (var index = 0; index < selectvalues.length; index++){
		for (var inner_index = 0; inner_index < selectvalues[index].length; inner_index++){
			selectvalue = selectvalues[index][inner_index]
			
			if (selectvalue.platz.includes(arbpltz_val)){
				if (selectvalue.bez === ""){
					$("#Gemeinkosten").text(selectvalue.bez);
					$("#Gemeinkosten").val(selectvalue.bez);				
				}
				else{
					$("#Gemeinkosten").text(selectvalue.bez[0]);
					$("#Gemeinkosten").val(selectvalue.bez[0]);
				}
				
				var div = document.getElementById("Gemeinkosten");
				// removes the existing children before adding new anchors
				while (div.firstChild) {
					div.removeChild(div.firstChild);
				}
				var options = selectvalue.bez;
				for (var j = 0; j < options.length; j++) {
					var option = document.createElement("option");
					option.value = selectvalue.belegNr[j];
					option.text = options[j];
					div.appendChild(option);
				}
				break;
			}
		}
	}
    });
});

$(function(){
    $(".DAU").click(function(){
    $("#Dauer").text($(this).text());
    $("#Dauer").val($(this).text());
   });
});

$(document).ready(function($)
{
	//ajax row data
	var ajax_data =  JSON.parse('{{ tablecontent | tojson | safe}}');
	var random_id = function  () 
	{
		var id_num = Math.random().toString(9).substr(2,3);
		var id_str = Math.random().toString(36).substr(2);
		
		return id_num + id_str;
	}


	//--->create data table > start
	var tbl = '';
	tbl +='<table class="table table-hover" id ="table-selectable">'

		//--->create table header > start
		tbl +='<thead>';
			tbl +='<tr>';
			tbl +='<th>TagId</th>';
			tbl +='<th>Arbeitplatz Ist</th>';
			tbl +='<th>BelegNr</th>';
			tbl +='<th>Anfang TS</th>';
			tbl +='<th>Ende TS</th>';
			tbl +='<th>Dauer TS</th>';
			tbl +='<th>Anfang</th>';
			tbl +='<th>Ende</th>';
			tbl +='<th>Dauer</th>';
			tbl +='<th>Kurztext</th>';
			tbl +='</thead>';
		//--->create table header > end

		
		//--->create table body > start
		tbl +='<tbody>';

			//--->create table body rows > start
			$.each(ajax_data, function(index, val) 
			{
				//you can replace with your database row id
				var row_id = random_id();

				//loop through ajax row data
				tbl +='<tr row_id="'+row_id+'">';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="TagId">'+val['TagId']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="Arbeitplatz">'+val['Arbeitplatz']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="BelegNr">'+val['BelegNr']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="AnfangTS">'+val['AnfangTS']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="EndeTS">'+val['EndeTS']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="DauerTS">'+val['DauerTS']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="Anfang">'+val['Anfang']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="Ende">'+val['Ende']+'</div></td>';
					tbl +='<td ><div class="row_data" edit_type="click" col_name="Dauer">'+val['Dauer']+'</div></td>';
          tbl +='<td ><div class="row_data" edit_type="click" col_name="Kurztext">'+val['Kurztext']+'</div></td>';
				tbl +='</tr>';
			});

			//--->create table body rows > end

		tbl +='</tbody>';
		//--->create table body > end

	tbl +='</table>'	
	//--->create data table > end

	//out put table data
	$(document).find('.tbl_user_data').html(tbl);

	//--->make div editable > start
	$(document).on('click', '.row_data', function(event) 
	{
		event.preventDefault(); 

		if($(this).attr('edit_type') == 'button')
		{
			return false; 
		}

		//make div editable
		$(this).closest('div').attr('contenteditable', 'true');
		//add bg css
		$(this).addClass('bg-warning').css('padding','5px');

		$(this).focus();
	})	
	//--->make div editable > end


	//--->save single field data > start
	$(document).on('focusout', '.row_data', function(event) 
	{
		event.preventDefault();

		if($(this).attr('edit_type') == 'button')
		{
			return false; 
		}

		var row_id = $(this).closest('tr').attr('row_id'); 
		
		var row_div = $(this)				
		.removeClass('bg-warning') //add bg css
		.css('padding','')

		var col_name = row_div.attr('col_name'); 
		var col_val = row_div.html(); 

		var arr = {};
		arr[col_name] = col_val;

		//use the "arr"	object for your ajax call
		$.extend(arr, {row_id:row_id});

		//out put to show
		$('.post_msg').html( '<pre class="bg-success">'+JSON.stringify(arr, null, 2) +'</pre>');
		
	})	
	//--->save single field data > end

 
	//--->button > edit > start	
	$(document).on('click', '.btn_edit', function(event) 
	{
		event.preventDefault();
		var tbl_row = $(this).closest('tr');

		var row_id = tbl_row.attr('row_id');

		tbl_row.find('.btn_save').show();
		tbl_row.find('.btn_cancel').show();

		//hide edit button
		tbl_row.find('.btn_edit').hide(); 

		//make the whole row editable
		tbl_row.find('.row_data')
		.attr('contenteditable', 'true')
		.attr('edit_type', 'button')
		.addClass('bg-warning')
		.css('padding','3px')

		//--->add the original entry > start
		tbl_row.find('.row_data').each(function(index, val) 
		{  
			//this will help in case user decided to click on cancel button
			$(this).attr('original_entry', $(this).html());
		}); 		
		//--->add the original entry > end

	});
	//--->button > edit > end


	//--->button > cancel > start	
	$(document).on('click', '.btn_cancel', function(event) 
	{
		event.preventDefault();

		var tbl_row = $(this).closest('tr');

		var row_id = tbl_row.attr('row_id');

		//hide save and cacel buttons
		tbl_row.find('.btn_save').hide();
		tbl_row.find('.btn_cancel').hide();

		//show edit button
		tbl_row.find('.btn_edit').show();

		//make the whole row editable
		tbl_row.find('.row_data')
		.attr('edit_type', 'click')
		.removeClass('bg-warning')
		.css('padding','') 

		tbl_row.find('.row_data').each(function(index, val) 
		{   
			$(this).html( $(this).attr('original_entry') ); 
		});  
	});
	//--->button > cancel > end

	
	//--->save whole row entery > start	
	$(document).on('click', '.btn_save', function(event) 
	{
		event.preventDefault();
		var tbl_row = $(this).closest('tr');

		var row_id = tbl_row.attr('row_id');

		
		//hide save and cacel buttons
		tbl_row.find('.btn_save').hide();
		tbl_row.find('.btn_cancel').hide();

		//show edit button
		tbl_row.find('.btn_edit').show();


		//make the whole row editable
		tbl_row.find('.row_data')
		.attr('edit_type', 'click')
		.removeClass('bg-warning')
		.css('padding','') 

		//--->get row data > start
		var arr = {}; 
		tbl_row.find('.row_data').each(function(index, val) 
		{   
			var col_name = $(this).attr('col_name');  
			var col_val  =  $(this).html();
			arr[col_name] = col_val;
		});
		//--->get row data > end

		//use the "arr"	object for your ajax call
		$.extend(arr, {row_id:row_id});

		//out put to show
		$('.post_msg').html( '<pre class="bg-success">'+JSON.stringify(arr, null, 2) +'</pre>')
		 

	});
	//--->save whole row entery > end

		// get selected row
	// display selected row data in text input
	
	var table = document.getElementById("table-selectable"),rIndex;

	// console.log("table:",table)
	for(var i = 1; i < table.rows.length; i++)
	{
		table.rows[i].onclick = function()
		{
			var selectvalues =  JSON.parse('{{ auftraglst_ajax | tojson | safe}}');
			selectvalue = selectvalues[i-2]
			rIndex = this.rowIndex;
			var arbeitsplatz = document.getElementById("arbeitsplatz");
			var Gemeinkosten = document.getElementById("Gemeinkosten");
			var selectedValue = arbeitsplatz.value;
			var selectedText = arbeitsplatz.options[arbeitsplatz.selectedIndex].text;
			console.log("rIndex",selectedText);

			for (var k = 0; k < selectvalue.length; k++) {
				if (selectvalue[k].id.includes(this.cells[1].innerText)){
					$("#arbeitsplatz").val(selectvalue[k].platz);
				}
				console.log("selectvalue[k].bez[j]",selectvalue[k]);
				if (selectvalue[k].belegNr.includes(this.cells[2].innerText)){
					for (var j = 0; j < selectvalue[k].belegNr.length; j++) {
						if (selectvalue[k].belegNr[j].includes(this.cells[2].innerText)){
							// // removes the existing children before adding new anchors
							while (Gemeinkosten.firstChild) {
								Gemeinkosten.removeChild(Gemeinkosten.firstChild);
							}
							var options = selectvalue[k].bez;
							for (var l = 0; l < options.length; l++) {
								var option = document.createElement("option");
								option.value = selectvalue[k].belegNr[l];
								option.text = options[l];
								Gemeinkosten.appendChild(option);
							}
							$("#Gemeinkosten").val(selectvalue[k].belegNr[j]);
							$("#old_beleg_nr").val(selectvalue[k].belegNr[j]);
						}
					}
				}				
			}	
			
			// $("#Gemeinkosten").text(this.cells[2].innerText);
			// $("#anfangTS").text(this.cells[3].innerText);
			// $("#Dauer").text(this.cells[8].innerText);
			document.getElementById("anfangTS").value = this.cells[3].innerText;
			document.getElementById("dauer").value = this.cells[5].innerText;
			document.getElementById("GKA").value = this.cells[9].innerText;
			document.getElementById("GKA").text = this.cells[9].innerText;
		};
	}

	// edit the row
	// $(function(){
    // $("#Ändern").click(function(){
	// 	var dauer = document.getElementById("Dauer").value;
	// 	var kurztext = document.getElementById("GKA").value;
	// 	var anfangTS = document.getElementById("anfangTS").value;
	// 	console.log("anderen");
	// 	console.log(dauer);
	// 	console.log(kurztext);
	// 	console.log(anfangTS);
	// 	table.rows[rIndex].cells[8].innerText = document.getElementById("Dauer").value;
	// 	table.rows[rIndex].cells[9].innerText = document.getElementById("GKA").value;
    // });
	// });

// Get the button element
// var button = document.getElementById("Ändern");
// // Add an event listener to the button
// button.addEventListener("click", function() {
// 	// Change the value of the button
// 		var dauer = document.getElementById("Dauer").value;
// 		var arbeitsplatz = document.getElementById("arbeitsplatz").value;
// 		var Gemeinkosten = document.getElementById("Gemeinkosten").value;
// 		console.log("anderen");
// 		console.log(dauer);
// 		console.log(arbeitsplatz);
// 	button.value = Gemeinkosten;
// });

}); 
</script>
{% endblock %}
